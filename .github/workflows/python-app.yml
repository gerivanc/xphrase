name: XPhrase Generator CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.8", "3.9", "3.10", "3.11", "3.12"]

    steps:
    - uses: actions/checkout@v4

    - name: Debug - Show project structure
      run: |
        echo "Current commit:"
        git log -1 --oneline
        echo "Project structure:"
        find . -name "*.py" -type f | head -20
        echo "Checking data files:"
        if [ -d "data" ]; then
          echo "Data directory exists"
          ls -la data/
        fi

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 build

    - name: Lint with flake8
      run: |
        # stop the build if there are Python syntax errors or undefined names
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # exit-zero treats all errors as warnings
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

    - name: Run unit tests
      run: |
        if [ -d "tests" ]; then
          python -m unittest discover tests/ -v
        else
          echo "No tests directory found, skipping unit tests"
        fi

    - name: Build package
      run: |
        python -m build

    - name: Install package locally
      run: |
        pip install -e .

    - name: Test CLI functionality
      run: |
        # Test version command
        python xphrase.py --version
        
        # Test default phrase generation (8 words)
        echo "Testing default generation:"
        python xphrase.py
        
        # Test specific word count
        echo "Testing specific word count:"
        for count in 5 6 7 8 9 10; do
          echo "Testing --count $count"
          python xphrase.py --count $count
        done
        
        # Test custom word range
        echo "Testing custom word range:"
        python xphrase.py --min 5 --max 10
        
        # Test phrase validation
        echo "Testing phrase validation:"
        phrase=$(python xphrase.py --count 8)
        echo "Generated phrase: $phrase"
        
        if [ -n "$phrase" ]; then
          echo "✓ Phrase generated successfully"
        else
          echo "✗ Failed to generate phrase"
          exit 1
        fi

    - name: Test word manager module
      run: |
        python -c "
from word_manager import WordManager
wm = WordManager()
print('✓ WordManager initialized successfully')
words = [wm.get_random_word() for _ in range(3)]
print('✓ Random words generated')
separators = [wm.get_separator() for _ in range(3)]
print('✓ Separators generated')
print('✓ All modules working correctly')
"

    - name: Verify data files and structure
      run: |
        echo "Verifying data files existence and structure:"
        
        # Check if data directory exists
        if [ ! -d "data" ]; then
          echo "✗ Missing data directory"
          exit 1
        fi
        
        # Check for Python data files and test imports
        python -c "
try:
    from data.english_words import ENGLISH_WORDS
    from data.portuguese_words import PORTUGUESE_WORDS
    from data.german_words import GERMAN_WORDS
    print('✓ All data modules imported successfully')
    print(f'✓ English words: {len(ENGLISH_WORDS)}')
    print(f'✓ Portuguese words: {len(PORTUGUESE_WORDS)}')
    print(f'✓ German words: {len(GERMAN_WORDS)}')
    
    # Verify word counts match README specifications
    assert len(ENGLISH_WORDS) == 1334, f'English words count mismatch: {len(ENGLISH_WORDS)}'
    assert len(PORTUGUESE_WORDS) == 1333, f'Portuguese words count mismatch: {len(PORTUGUESE_WORDS)}'
    assert len(GERMAN_WORDS) == 1333, f'German words count mismatch: {len(GERMAN_WORDS)}'
    print('✓ All word counts match specifications')
    
except ImportError as e:
    print(f'✗ Import error: {e}')
    exit(1)
except AssertionError as e:
    print(f'✗ Assertion error: {e}')
    exit(1)
"

    - name: Test phrase generation rules compliance
      run: |
        echo "Testing phrase generation rules compliance:"
        python -c "
from xphrase import XPhraseGenerator
import re

generator = XPhraseGenerator()

# Test multiple phrases to verify rules
for i in range(3):
    phrase = generator.generate_phrase(5, 5)
    print(f'Test {i+1}: {phrase}')
    
    # Basic rule checks
    assert len(phrase) > 0, 'Phrase should not be empty'
    assert any(char.isdigit() for char in phrase), 'Phrase should contain digits'
    assert any(not char.isalnum() and not char.isspace() for char in phrase), 'Phrase should contain special characters'
    assert phrase[-1].isupper(), 'Last character should be uppercase'
    
    print(f'✓ Phrase {i+1} passed all rule checks')

print('✓ All phrase generation rules validated successfully')
"
